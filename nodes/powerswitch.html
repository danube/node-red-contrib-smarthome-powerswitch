<!-- edit template -->
<script type="text/html" data-template-name="powerswitch">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Power Switch">
    </div>

    <h3>Toggle message</h3>
    <div class="form-row">
        <label for="node-input-toggleTopic"><i class="fa fa-tasks"></i> Topic</label>
        <input type="text" id="node-input-toggleTopic" placeholder="Expecting 'toggle' if left blank">
    </div>
    <div class="form-row">
        <label for="node-input-togglePayload"><i class="fa fa-tag"></i> Payload</label>
        <input type="hidden" id="node-input-togglePayloadType">
        <input style="width:70%" type="text" id="node-input-togglePayload">
    </div>

    <h3>Motion detector</h3>
    <div class="form-row">
        <label for="node-input-motionTopic"><i class="fa fa-tasks"></i> Topic</label>
        <input type="text" id="node-input-motionTopic" placeholder="Expecting 'motion' if left blank">
    </div>
    <div class="form-row">
        <label for="node-input-motionPayloadOn"><i class="fa fa-tag"></i> On payload</label>
        <input type="hidden" id="node-input-motionPayloadOnType">
        <input style="width:70%" type="text" id="node-input-motionPayloadOn">
    </div>
    <div class="form-row">
        <label for="node-input-motionPayloadOff"><i class="fa fa-tag"></i> Off payload</label>
        <input type="hidden" id="node-input-motionPayloadOffType">
        <input style="width:70%" type="text" id="node-input-motionPayloadOff">
    </div>
    <div class="form-row">
        <label><i class="fa fa-sliders"></i> Timeout</label>
        <input type="number" id="node-input-motionTimeoutValue" min="1" style="text-align: end; width: 70px !important">
        <select id="node-input-motionTimeoutUnit" style="width:140px !important">
            <option value="s">Seconds</option>
            <option value="m">Minutes</option>
            <option value="h">Hours</option>
        </select>
    </div>
    
    <h3>Force message</h3>
    <div class="form-row">
        <label for="node-input-forceTopic"><i class="fa fa-tasks"></i> Topic</label>
        <input type="text" id="node-input-forceTopic" placeholder="Expecting 'force' if left blank">
    </div>
    <div class="form-row">
        <label for="node-input-forcePayloadOn"><i class="fa fa-tag"></i> On payload</label>
        <input type="hidden" id="node-input-forcePayloadOnType">
        <input style="width:70%" type="text" id="node-input-forcePayloadOn">
    </div>
    <div class="form-row">
        <label for="node-input-forcePayloadOff"><i class="fa fa-tag"></i> Off payload</label>
        <input type="hidden" id="node-input-forcePayloadOffType">
        <input style="width:70%" type="text" id="node-input-forcePayloadOff">
    </div>

    <h3>Actuator feedback message</h3>
    <div class="form-row">
        <label><i class="fa fa-power-off"></i> Enable</label>
        <input type="checkbox" id="node-input-feedbackActive" style="display:inline-block; width:auto;">
    </div>
    <div id="feedbackConfig">
        <div class="form-row">
            <label for="node-input-feedbackTopic"><i class="fa fa-tasks"></i> Topic</label>
            <input type="text" id="node-input-feedbackTopic" placeholder="Expecting 'feedback' if left blank">
        </div>
        <div class="form-row">
            <label for="node-input-feedbackPayloadOn"><i class="fa fa-tag"></i> On payload</label>
            <input type="hidden" id="node-input-feedbackPayloadOnType">
            <input style="width:70%" type="text" id="node-input-feedbackPayloadOn">
        </div>
        <div class="form-row">
            <label for="node-input-feedbackPayloadOff"><i class="fa fa-tag"></i> Off payload</label>
            <input type="hidden" id="node-input-feedbackPayloadOffType">
            <input style="width:70%" type="text" id="node-input-feedbackPayloadOff">
        </div>
    </div>

    <h3>Absolute timeout</h3>
    <div class="form-row">
        <label><i class="fa fa-sliders"></i> Time</label>
        <input type="checkbox" id="node-input-absTimeoutActive" style="display:inline-block; width:auto;">
        <input type="number" id="node-input-absTimeoutValue" min="1" style="text-align: end; width: 70px !important; margin-left: 5px">
        <select id="node-input-absTimeoutUnit" style="width:140px !important">
            <option value="s">Seconds</option>
            <option value="m">Minutes</option>
            <option value="h">Hours</option>
        </select>
    </div>

</script>



<!-- node definition -->
<script type="text/javascript">
    RED.nodes.registerType('powerswitch',{
        category: 'Smart Home',
        color: '#FDF0C2',
        defaults: {
            name: {value: ""},
            toggleTopic: {value: ""},
            togglePayload: {value: "", validate: RED.validators.typedInput("togglePayloadType")},
            togglePayloadType: {value: "initval"},
            motionTopic: {value: ""},
            motionPayloadOn: {value: "", validate: RED.validators.typedInput("motionPayloadOnType")},
            motionPayloadOnType: {value: "initval"},
            motionPayloadOff: {value: "", validate: RED.validators.typedInput("motionPayloadOffType")},
            motionPayloadOffType: {value: "initval"},
            motionTimeoutValue: {value: "2", required: true, validate:RED.validators.number()},
            motionTimeoutUnit: {value: "m"},
            feedbackActive: {value: ""},
            feedbackTopic: {value: ""},
            feedbackPayloadOn: {value: true, validate: RED.validators.typedInput("feedbackPayloadOnType")},
            feedbackPayloadOnType: {value: "initval"},
            feedbackPayloadOff: {value: false, validate: RED.validators.typedInput("feedbackPayloadOffType")},
            feedbackPayloadOffType: {value: "initval"},
            forceTopic: {value: ""},
            forcePayloadOn: {value: true, validate: RED.validators.typedInput("forcePayloadOnType")},
            forcePayloadOnType: {value: "initval"},
            forcePayloadOff: {value: false, validate: RED.validators.typedInput("forcePayloadOffType")},
            forcePayloadOffType: {value: "initval"},
            absTimeoutActive: {value: false},
            absTimeoutValue: {value: "1", required: true, validate:RED.validators.number()},    // TODO validate this time to be higher than motionTimeout
            absTimeoutUnit: {value: "h"}
        },
        inputs: 1,
        outputs: 1,
        outputLabels: "Control output",
        icon: "font-awesome/fa-lightbulb-o",
        label: function() {
            return this.name || "Power Switch"
        },
        oneditprepare: function() {
            if (this.togglePayloadType === 'initval') {
                $("#node-input-togglePayloadType").val('bool');
            }
            if (this.motionPayloadOnType === 'initval') {
                $("#node-input-motionPayloadOnType").val('bool');
            }
            if (this.motionPayloadOffType === 'initval') {
                $("#node-input-motionPayloadOffType").val('bool');
            }
            if (this.feedbackPayloadOnType === 'initval') {
                $("#node-input-feedbackPayloadOnType").val('bool');
            }
            if (this.feedbackPayloadOffType === 'initval') {
                $("#node-input-feedbackPayloadOffType").val('bool');
            }
            if (this.forcePayloadOnType === 'initval') {
                $("#node-input-forcePayloadOnType").val('bool');
            }
            if (this.forcePayloadOffType === 'initval') {
                $("#node-input-forcePayloadOffType").val('bool');
            }

            $("#node-input-togglePayload").typedInput({
                default: 'bool',
                typeField: $("#node-input-togglePayloadType"),
                types:['str','num','bool']
            });
            $("#node-input-motionPayloadOn").typedInput({
                default: 'bool',
                typeField: $("#node-input-motionPayloadOnType"),
                types:['str','num','bool']
            });
            $("#node-input-motionPayloadOff").typedInput({
                default: 'bool',
                typeField: $("#node-input-motionPayloadOffType"),
                types:['str','num','bool']
            });
            $("#node-input-feedbackPayloadOn").typedInput({
                default: 'bool',
                typeField: $("#node-input-feedbackPayloadOnType"),
                types:['str','num','bool']
            });
            $("#node-input-feedbackPayloadOff").typedInput({
                default: 'bool',
                typeField: $("#node-input-feedbackPayloadOffType"),
                types:['str','num','bool']
            });
            $("#node-input-forcePayloadOn").typedInput({
                default: 'bool',
                typeField: $("#node-input-forcePayloadOnType"),
                types:['str','num','bool']
            });
            $("#node-input-forcePayloadOff").typedInput({
                default: 'bool',
                typeField: $("#node-input-forcePayloadOffType"),
                types:['str','num','bool']
            });

            // hide feedback config area
            $("#node-input-feedbackActive").on('change', function(){
                if ($("#node-input-feedbackActive")[0].checked) {
                    $('#feedbackConfig').show('fast');
                } else {
                    $('#feedbackConfig').hide('fast');
                }
            })

            // hide absTimeout config area
            $("#node-input-absTimeoutActive").on('change', function(){
                if ($("#node-input-absTimeoutActive")[0].checked) {
                    $('#node-input-absTimeoutValue').prop('disabled', false);
                    $('#node-input-absTimeoutUnit').prop('disabled', false);
                } else {
                    $('#node-input-absTimeoutValue').prop('disabled', true);
                    $('#node-input-absTimeoutUnit').prop('disabled', true);
                }
            })

        }
    });
</script>








<!-- help text -->
<script type="text/html" data-help-name="powerswitch">
    <p>Power switch for lights, smart plugs or anything else handling on/off commands.</p>
    <p>Control the output with pushbuttons, motion detectors, over the web or anything else.</p>

    <h3>Input</h3>
    <dl class="message-properties">
        <dt>topic<span class="property-type">as configured</span></dt>
        <dd>Can be a toggle (like a wall button), motion detector, actuator feedback or force command. It must meet either the defaults or the configured string. Defaults are described in the input fields when left blank.</dd>
        <dt>payload<span class="property-type">as configured</span></dt>
        <dd>Must meet the setting in the configuration editor. Defaults are <code>true</code> and <code>false</code>.</dd>
    </dl>

    <h3>Output</h3>
    <dl class="message-properties">
        <dt>topic<span class="property-type">string</span></dt>
        <dd>Hardcoded <code>command</code>, will be configurable in the near future.</dd>
        <dt>payload<span class="property-type">string</span></dt>
        <dd><code>true</code> or <code>false</code>.</dd>
    </dl>
    
    <h3>Configuration</h3>
        <h4 style="font-weight: bolder;">Name</h4>
        <p>Defines the node name, which will also be shown on the drawpad.</p>

        <h4 style="font-weight: bolder;">Toggle message</h4>
        <p>The values 'Topic' and 'Payload' define the expected content of the incoming message for a toggling event. The Control output then will be inverted to the previous command or, if actuator feedback is enabled, to the recently received feedback state. Incoming <code>msg.topic</code>must match the value configured in the field 'Topic' and incoming <code>msg.payload</code> must match the value configured in the field 'Payload'. If the configuration field 'Topic' is empty, the value <code>toggle</code> is expected as <code>msg.topic</code>.</p>
        
        <h4 style="font-weight: bolder;">Motion detector</h4>
        <p>The values 'Topic' and 'Payload' define the expected content of the incoming message for an event to trigger on the device. The Control output then will turn <code>true</code>. Incoming <code>msg.topic</code>must match the value configured in the field 'Topic' and incoming <code>msg.payload</code> must match the value configured in the field 'On payload' (coming trigger from the sensor) and 'Off payload' (going trigger from the sensor). If the configuration field 'Topic' is empty, the value <code>motion</code> is expected as <code>msg.topic</code>. Use the 'Timeout' configuration to set the delay until the light should be turned off.</p>
        
        <h4 style="font-weight: bolder;">Force message</h4>
        <p>If you want the device to turn on or off, you either use a button to toggle the device state or force the device to change to that state you want to have it. For example, if you have some house leaving button or so with which you turn off all lights in your environment, let the button send the relevant 'Topic' and 'Off payload'.</p>

        <h4 style="font-weight: bolder;">Actuator feedback message</h4>
        <p>If whatever device you control sends a feedback, enable the option and connect the feedback signal to the node. If this option is disabled, the node thinks the device is turned on or off, depending on the outgoing command signal. If this option is turned on, the node waits for the feedback signal. Use the fields to configure, how your feedback signal is constructed.</p>

        <h4 style="font-weight: bolder;">Absolute timeout</h4>
        <p>Enable this option if you want to configure an absolute timeout. This will automatically turn off the actor after the configured time. Use this i.e. to turn off lights you may have forgotten to manually turn off with your wall button.</p>

</script>




<!--
    
-->