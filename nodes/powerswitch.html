<!-- edit template -->
<script type="text/html" data-template-name="powerswitch">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Power Switch">
    </div>

    <h3>Toggle message</h3>
    <div class="form-row">
        <label for="node-input-toggleTopic"><i class="fa fa-tasks"></i> Topic</label>
        <input type="text" id="node-input-toggleTopic" placeholder="Expecting 'toggle' if left blank">
    </div>
    <div class="form-row">
        <label for="node-input-toggleMessage"><i class="fa fa-tag"></i> Payload</label>
        <input type="hidden" id="node-input-toggleMessageType">
        <input style="width:70%" type="text" id="node-input-toggleMessage">
    </div>

    <h3>Actuator feedback message</h3>
    <div class="form-row">
        <label><i class="fa fa-power-off"></i> Enable</label>
        <input type="checkbox" id="node-input-feedbackActive" style="display:inline-block; width:auto;">
    </div>
    <div id="feedbackConfig">
        <div class="form-row">
            <label for="node-input-feedbackTopic"><i class="fa fa-tasks"></i> Topic</label>
            <input type="text" id="node-input-feedbackTopic" placeholder="Expecting 'feedback' if left blank">
        </div>
        <div class="form-row">
            <label for="node-input-feedbackMessageOn"><i class="fa fa-tag"></i> On payload</label>
            <input type="hidden" id="node-input-feedbackMessageOnType">
            <input style="width:70%" type="text" id="node-input-feedbackMessageOn">
        </div>
        <div class="form-row">
            <label for="node-input-feedbackMessageOff"><i class="fa fa-tag"></i> Off payload</label>
            <input type="hidden" id="node-input-feedbackMessageOffType">
            <input style="width:70%" type="text" id="node-input-feedbackMessageOff">
        </div>
    </div>
    <h3>Force message</h3>
    <div class="form-row">
        <label for="node-input-forceTopic"><i class="fa fa-tasks"></i> Topic</label>
        <input type="text" id="node-input-forceTopic" placeholder="Expecting 'force' if left blank">
    </div>
    <div class="form-row">
        <label for="node-input-forceMessageOn"><i class="fa fa-tag"></i> On payload</label>
        <input type="hidden" id="node-input-forceMessageOnType">
        <input style="width:70%" type="text" id="node-input-forceMessageOn">
    </div>
    <div class="form-row">
        <label for="node-input-forceMessageOff"><i class="fa fa-tag"></i> Off payload</label>
        <input type="hidden" id="node-input-forceMessageOffType">
        <input style="width:70%" type="text" id="node-input-forceMessageOff">
    </div>

    <h3>Behaviour configuration</h3>
    <!-- <div class="form-row">
        <label for="node-input-timeoutValue"><i class="fa fa-sliders"></i> Timeout [s]</label>
        <input type="text" id="node-input-timeoutValue" placeholder="'0' to disable'">
    </div> -->


    <div class="form-row">
        <label><i class="fa fa-sliders"></i> Timeout</label>
        <input type="checkbox" id="node-input-timeoutActive" style="display:inline-block; width:auto;">
        <input type="number" id="node-input-timeoutValue" style="text-align: end; width: 70px !important; margin-left: 5px">
        <select id="node-input-timeoutUnit" style="width:140px !important">
            <option value="s">Seconds</option>
            <option value="m">Minutes</option>
            <option value="h">Hours</option>
        </select>
    </div>

</script>



<!-- node definition -->
<script type="text/javascript">
    RED.nodes.registerType('powerswitch',{
        category: 'Smart Home',
        color: '#FDF0C2',
        defaults: {
            name: {value:""},
            toggleTopic: {value:""},
            toggleMessage: {value:"", validate: RED.validators.typedInput("toggleMessageType")},
            toggleMessageType: {value:"initval"},
            feedbackActive: {value: ""},
            feedbackTopic: {value:""},
            feedbackMessageOn: {value: true},
            feedbackMessageOnType: {value:"initval"},
            feedbackMessageOff: {value: false},
            feedbackMessageOffType: {value:"initval"},
            forceTopic: {value: ""},
            forceMessageOn: {value: true},
            forceMessageOnType: {value: "initval"},
            forceMessageOff: {value: false},
            forceMessageOffType: {value: "initval"},
            timeoutActive: {value: false},
            timeoutValue: {value: "0", required: true, validate:RED.validators.number()},
            timeoutUnit: {value: "m"}
        },
        inputs:1,
        outputs:1,
        outputLabels: "Control output",
        icon: "font-awesome/fa-lightbulb-o",
        label: function() {
            return this.name || "Power Switch"
        },
        oneditprepare: function() {
            if (this.toggleMessageType === 'initval') {
                $("#node-input-toggleMessageType").val('bool');
            }
            if (this.feedbackMessageOnType === 'initval') {
                $("#node-input-feedbackMessageOnType").val('bool');
            }
            if (this.feedbackMessageOffType === 'initval') {
                $("#node-input-feedbackMessageOffType").val('bool');
            }
            if (this.forceMessageOnType === 'initval') {
                $("#node-input-forceMessageOnType").val('bool');
            }
            if (this.forceMessageOffType === 'initval') {
                $("#node-input-forceMessageOffType").val('bool');
            }
            $("#node-input-toggleMessage").typedInput({
                default: 'bool',
                typeField: $("#node-input-toggleMessageType"),
                types:['str','num','bool','json','bin']
            });

            $("#node-input-feedbackMessageOn").typedInput({
                default: 'bool',
                typeField: $("#node-input-feedbackMessageOnType"),
                types:['str','num','bool','json','bin']
            });
            $("#node-input-feedbackMessageOff").typedInput({
                default: 'bool',
                typeField: $("#node-input-feedbackMessageOffType"),
                types:['str','num','bool','json','bin']
            });
            $("#node-input-forceMessageOn").typedInput({
                default: 'bool',
                typeField: $("#node-input-forceMessageOnType"),
                types:['str','num','bool','json','bin']
            });
            $("#node-input-forceMessageOff").typedInput({
                default: 'bool',
                typeField: $("#node-input-forceMessageOffType"),
                types:['str','num','bool','json','bin']
            });

            // hide feedback config area
            $("#node-input-feedbackActive").on('change', function(){
                if ($("#node-input-feedbackActive")[0].checked) {
                    $('#feedbackConfig').show('fast');
                } else {
                    $('#feedbackConfig').hide('fast');
                }
            })

            // hide timeout config area
            $("#node-input-timeoutActive").on('change', function(){
                if ($("#node-input-timeoutActive")[0].checked) {
                    $('#node-input-timeoutValue').prop('disabled', false);
                    $('#node-input-timeoutUnit').prop('disabled', false);
                } else {
                    $('#node-input-timeoutValue').prop('disabled', true);
                    $('#node-input-timeoutUnit').prop('disabled', true);
                }
            })

        }
    });
</script>








<!-- help text -->
<script type="text/html" data-help-name="powerswitch">
    <p>Power switch for lights, smart plugs or anything else handling on/off commands.</p>
    <p>Control the output with pushbuttons, motion detectors, over the web or anything else.</p>

    <h3>Input</h3>
    <dl class="message-properties">
        <dt>topic<span class="property-type">as configured</span></dt>
        <dd>Can be a toggle, actuator feedback or force command. It must meet either the
            defaults or the configured string. Defaults are described in the input fields if blank.</dd>
        <dt>payload<span class="property-type">as configured</span></dt>
        <dd>Must meet the setting in the configuration editor. Defaults are <code>true</code> and <code>false</code>.</dd>
    </dl>

    <h3>Output</h3>
    <dl class="message-properties">
        <dt>topic<span class="property-type">string | buffer</span></dt>
        <dd>this is the topic</dd>
        <dt>payload<span class="property-type">string | buffer</span></dt>
        <dd>this is the payload</dd>
    </dl>
    
    <h3>Configuration</h3>
        <h4 style="font-weight: bolder;">Name</h4>
        <p>Defines the node name, which will also be shown on the drawpad.</p>

        <h4 style="font-weight: bolder;">Toggle message</h4>
        <p>The values 'Topic' and 'Payload' define the expected content of the incoming message for a toggling event. The Control output then will be inverted to the previous command or, if actuator feedback is enabled, to the recently received feedback state. Incoming <code>msg.topic</code>must match the value configured in the field 'Topic' and incoming <code>msg.payload</code> must match the value configured in the field 'Topic'. If the configuration field 'Topic' is empty, the value <code>topic</code> is expected as <code>msg.topic</code>.</p>
        
        <h4 style="font-weight: bolder;">Actuator feedback message</h4>
        <p>If whatever device you control sends a feedback, enable the option and connect the feedback signal to the node. If this option is disabled, the node thinks the device is turned on or off, depending on the outgoing command signal. If this option is turned on, the node waits for the feedback signal. Use the fields to configure, how your feedback signal is constructed.</p>

        <h4 style="font-weight: bolder;">Force message</h4>
        <p>If you want the device to turn on or off, you either use a button to toggle the device state or force the device to change to that state you want to have it. For example, if you want to control a lamp with a motion detector, the lamp must go on, if motion has been detected. Hence, let the motion detector send a message with the configured Topic as <code>msg.topic</code> (or 'force' if left blank) and the corresponding 'On payload'. Use 'Timeout' to set the delay, until the light should be turned off. Another example is some house leaving button, with which you might want to turn off all lights in your environment. Let the button send the relevant 'Topic' and 'Off payload'.</p>

        <h4 style="font-weight: bolder;">Behaviour configuration</h4>
        <p>'Timeout' must initially be enabled. It defines a time, until a turned on device will be turned off. Use this for motion detectors or to turn off lights you may have forgotten to turn off.</p>
    
</script>