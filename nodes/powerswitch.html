<script type="text/html" data-template-name="powerswitch">

    <!-- Name -->
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]placeholder.name">
    </div>

    <!-- Toggle -->
    <h3><span data-i18n="head.toggle"></span></h3>
    <div class="form-row">
        <label for="node-input-toggleTopic"><i class="fa fa-tasks"></i> <span data-i18n="common.topic"></span></label>
        <input type="text" id="node-input-toggleTopic" data-i18n="[placeholder]placeholder.toggleTopic">
    </div>
    <div class="form-row">
        <label for="node-input-togglePayload"><i class="fa fa-tag"></i> <span data-i18n="common.payload"></span></label>
        <input type="hidden" id="node-input-togglePayloadType">
        <input style="width:70%" type="text" id="node-input-togglePayload">
    </div>

    <!-- Motion detector -->
    <h3><span data-i18n="head.motion"></span></h3>
    <div class="form-row">
        <label for="node-input-motionTopic"><i class="fa fa-tasks"></i> <span data-i18n="common.topic"></span></label>
        <input type="text" id="node-input-motionTopic" data-i18n="[placeholder]placeholder.motionTopic">
    </div>
    <div class="form-row">
        <label for="node-input-motionPayloadOn"><i class="fa fa-tag"></i> <span data-i18n="common.onPayload"></span></label>
        <input type="hidden" id="node-input-motionPayloadOnType">
        <input style="width:70%" type="text" id="node-input-motionPayloadOn">
    </div>
    <div class="form-row">
        <label for="node-input-motionPayloadOff"><i class="fa fa-tag"></i> <span data-i18n="common.offPayload"></span></label>
        <input type="hidden" id="node-input-motionPayloadOffType">
        <input style="width:70%" type="text" id="node-input-motionPayloadOff">
    </div>
    <div class="form-row">
        <label><i class="fa fa-sliders"></i> <span data-i18n="common.timeout"></span></label>
        <input type="number" id="node-input-motionTimeoutValue" min="1" style="text-align: end; width: 70px !important">
        <select id="node-input-motionTimeoutUnit" style="width:140px !important">
            <option value="s" data-i18n="common.seconds"></option>
            <option value="m" data-i18n="common.minutes"></option>
            <option value="h" data-i18n="common.hours"></option>
        </select>
    </div>
    <div class="form-row">
        <label></label>
        <input type="checkbox" id="node-input-motionTimeoutOverride" style="margin-left:0px; vertical-align:top; width:auto !important;"> <label style="width:auto !important;" for="node-input-motionTimeoutOverride" data-i18n="common.timeoutoverride"></label>
    </div>
    
    <!-- Force message -->
    <h3><span data-i18n="head.force"></span></h3>
    <div class="form-row">
        <label for="node-input-forceTopic"><i class="fa fa-tasks"></i> <span data-i18n="common.topic"></span></label>
        <input type="text" id="node-input-forceTopic" data-i18n="[placeholder]placeholder.forceTopic">
    </div>
    <div class="form-row">
        <label for="node-input-forcePayloadOn"><i class="fa fa-tag"></i> <span data-i18n="common.onPayload"></span></label>
        <input type="hidden" id="node-input-forcePayloadOnType">
        <input style="width:70%" type="text" id="node-input-forcePayloadOn">
    </div>
    <div class="form-row">
        <label for="node-input-forcePayloadOff"><i class="fa fa-tag"></i> <span data-i18n="common.offPayload"></span></label>
        <input type="hidden" id="node-input-forcePayloadOffType">
        <input style="width:70%" type="text" id="node-input-forcePayloadOff">
    </div>

    <!-- Actuator feedback message -->
    <h3><span data-i18n="head.feedback"></span></h3>
    <div class="form-row">
        <label><i class="fa fa-power-off"></i> <span data-i18n="common.enable"></span></label>
        <input type="checkbox" id="node-input-feedbackActive" style="display:inline-block; width:auto;">
    </div>
    <div id="feedbackConfig">
        <div class="form-row">
            <label for="node-input-feedbackTopic"><i class="fa fa-tasks"></i> <span data-i18n="common.topic"></span></label>
            <input type="text" id="node-input-feedbackTopic" data-i18n="[placeholder]placeholder.feedbackTopic">
        </div>
        <div class="form-row">
            <label for="node-input-feedbackPayloadOn"><i class="fa fa-tag"></i> <span data-i18n="common.onPayload"></span></label>
            <input type="hidden" id="node-input-feedbackPayloadOnType">
            <input style="width:70%" type="text" id="node-input-feedbackPayloadOn">
        </div>
        <div class="form-row">
            <label for="node-input-feedbackPayloadOff"><i class="fa fa-tag"></i> <span data-i18n="common.offPayload"></span></label>
            <input type="hidden" id="node-input-feedbackPayloadOffType">
            <input style="width:70%" type="text" id="node-input-feedbackPayloadOff">
        </div>
    </div>

    <!-- Absolute timeout -->
    <h3><span data-i18n="head.abstimeout"></span></h3>
    <div class="form-row">
        <label><i class="fa fa-sliders"></i> <span data-i18n="common.time"></span></label>
        <input type="checkbox" id="node-input-absTimeoutActive" style="display:inline-block; width:auto;">
        <input type="number" id="node-input-absTimeoutValue" min="1" style="text-align: end; width: 70px !important; margin-left: 5px">
        <select id="node-input-absTimeoutUnit" style="width:140px !important">
            <option value="s" data-i18n="common.seconds"></option>
            <option value="m" data-i18n="common.minutes"></option>
            <option value="h" data-i18n="common.hours"></option>
        </select>
    </div>

    <!-- Output message -->
    <h3><span data-i18n="head.output"></span></h3>
    <div class="form-row">
        <label for="node-output-topic"><i class="fa fa-tasks"></i> <span data-i18n="common.topic"></span></label>
        <input type="text" id="node-output-topic" data-i18n="[placeholder]placeholder.outputTopic">
    </div>
    <div class="form-row">
        <label for="node-output-payloadOn"><i class="fa fa-tag"></i> <span data-i18n="common.onPayload"></span></label>
        <input type="hidden" id="node-output-payloadOnType">
        <input style="width:70%" type="text" id="node-output-payloadOn">
    </div>
    <div class="form-row">
        <label for="node-output-payloadOff"><i class="fa fa-tag"></i> <span data-i18n="common.offPayload"></span></label>
        <input type="hidden" id="node-output-payloadOffType">
        <input style="width:70%" type="text" id="node-output-payloadOff">
    </div>

</script>



<!-- node definition -->
<script type="text/javascript">
    RED.nodes.registerType('powerswitch',{
        category: 'Smart Home',
        color: '#C0DEED',
        defaults: {
            name: {value: ""},
            toggleTopic: {value: ""},
            togglePayload: {value: "true", validate: RED.validators.typedInput("togglePayloadType")},
            togglePayloadType: {value: "initval"},
            motionTopic: {value: ""},
            motionPayloadOn: {value: "true", validate: function(v) {return v != this.motionPayloadOff}},
            motionPayloadOnType: {value: "initval"},
            motionPayloadOff: {value: "false", validate: function(v) {return v != this.motionPayloadOn}},
            motionPayloadOffType: {value: "initval"},
            motionTimeoutValue: {value: "2", required: true, validate: function(v) {return v > 0}},
            motionTimeoutUnit: {value: "m"},
            motionTimeoutOverride: {value: false},
            feedbackActive: {value: ""},
            feedbackTopic: {value: ""},
            feedbackPayloadOn: {value: true, validate: function(v) {return v != this.feedbackPayloadOff || !this.feedbackActive}},
            feedbackPayloadOnType: {value: "initval"},
            feedbackPayloadOff: {value: false, validate: function(v) {return v != this.feedbackPayloadOn || !this.feedbackActive}},
            feedbackPayloadOffType: {value: "initval"},
            forceTopic: {value: ""},
            forcePayloadOn: {value: true, validate: function(v) {return v != this.forcePayloadOff}},
            forcePayloadOnType: {value: "initval"},
            forcePayloadOff: {value: false, validate: function(v) {return v != this.forcePayloadOn}},
            forcePayloadOffType: {value: "initval"},
            absTimeoutActive: {value: false},
            absTimeoutValue: {value: "1", required: true, validate: function(v) {
                let motionFactor = 1
                if (this.motionTimeoutUnit == "m") {motionFactor = 60}
                else if (this.motionTimeoutUnit == "h") {motionFactor = 3600}
                let absFactor = 1
                if (this.absTimeoutUnit == "m") {absFactor = 60}
                else if (this.absTimeoutUnit == "h") {absFactor = 3600}
                return v * absFactor > this.motionTimeoutValue * motionFactor || !this.absTimeoutActive}},
            absTimeoutUnit: {value: "h"}
        },
        inputs: 1,
        outputs: 1,
        icon: "font-awesome/fa-lightbulb-o",
        label: function() {
            let app = this.motionTimeoutValue + this.motionTimeoutUnit
            if (this.motionTimeoutOverride) {app = app + "*"}
            if (this.absTimeoutActive) {app = app + "/" + this.absTimeoutValue + this.absTimeoutUnit}
            return (this.name || "Power Switch") + " (" + app + ")"
        },
        oneditprepare: function() {
            if (this.togglePayloadType === 'initval') {
                $("#node-input-togglePayloadType").val('bool');
            }
            if (this.motionPayloadOnType === 'initval') {
                $("#node-input-motionPayloadOnType").val('bool');
            }
            if (this.motionPayloadOffType === 'initval') {
                $("#node-input-motionPayloadOffType").val('bool');
            }
            if (this.feedbackPayloadOnType === 'initval') {
                $("#node-input-feedbackPayloadOnType").val('bool');
            }
            if (this.feedbackPayloadOffType === 'initval') {
                $("#node-input-feedbackPayloadOffType").val('bool');
            }
            if (this.forcePayloadOnType === 'initval') {
                $("#node-input-forcePayloadOnType").val('bool');
            }
            if (this.forcePayloadOffType === 'initval') {
                $("#node-input-forcePayloadOffType").val('bool');
            }

            $("#node-input-togglePayload").typedInput({
                default: 'bool',
                typeField: $("#node-input-togglePayloadType"),
                types:['str','num','bool']
            });
            $("#node-input-motionPayloadOn").typedInput({
                default: 'bool',
                typeField: $("#node-input-motionPayloadOnType"),
                types:['str','num','bool']
            });
            $("#node-input-motionPayloadOff").typedInput({
                default: 'bool',
                typeField: $("#node-input-motionPayloadOffType"),
                types:['str','num','bool']
            });
            $("#node-input-feedbackPayloadOn").typedInput({
                default: 'bool',
                typeField: $("#node-input-feedbackPayloadOnType"),
                types:['str','num','bool']
            });
            $("#node-input-feedbackPayloadOff").typedInput({
                default: 'bool',
                typeField: $("#node-input-feedbackPayloadOffType"),
                types:['str','num','bool']
            });
            $("#node-input-forcePayloadOn").typedInput({
                default: 'bool',
                typeField: $("#node-input-forcePayloadOnType"),
                types:['str','num','bool']
            });
            $("#node-input-forcePayloadOff").typedInput({
                default: 'bool',
                typeField: $("#node-input-forcePayloadOffType"),
                types:['str','num','bool']
            });

            // hide feedback config area
            $("#node-input-feedbackActive").on('change', function(){
                if ($("#node-input-feedbackActive")[0].checked) {
                    $('#feedbackConfig').show('fast');
                } else {
                    $('#feedbackConfig').hide('fast');
                }
            })

            // hide absTimeout config area
            $("#node-input-absTimeoutActive").on('change', function(){
                if ($("#node-input-absTimeoutActive")[0].checked) {
                    $('#node-input-absTimeoutValue').prop('disabled', false);
                    $('#node-input-absTimeoutUnit').prop('disabled', false);
                } else {
                    $('#node-input-absTimeoutValue').prop('disabled', true);
                    $('#node-input-absTimeoutUnit').prop('disabled', true);
                }
            })

        }
    });
</script>